<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自訂面板傳送</title>
    <style>
        .hidden {
            display: none;
        }
    </style>
    <!--<script src="jquery-3.3.1.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <link href="bootstrap.min.css" rel="stylesheet" />-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
</head>

<body>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        //重写alert
        window.alert = function (name) {
            var iframe = document.createElement("IFRAME");
            iframe.style.display = "none";
            iframe.setAttribute("src", 'data:text/plain,');
            document.documentElement.appendChild(iframe);
            window.frames[0].window.alert(name);
            iframe.parentNode.removeChild(iframe);
        }
        //重写confirm 不显示ip地址  
        var wConfirm = window.confirm;
        window.confirm = function (message) {
            try {
                var iframe = document.createElement("IFRAME");
                iframe.style.display = "none";
                iframe.setAttribute("src", 'data:text/plain,');
                document.documentElement.appendChild(iframe);
                var alertFrame = window.frames[0];
                var iwindow = alertFrame.window;
                if (iwindow == undefined) {
                    iwindow = alertFrame.contentWindow;
                }
                var result = iwindow.confirm(message);
                iframe.parentNode.removeChild(iframe);
                return result;
            } catch (exc) {
                return wConfirm(message);
            }
        }
    </script>
    <script>
        window.onload = function () {
            const useNodeJS = false; // if you are not using a node server, set this value to false
            const defaultLiffId =
                "1656693260-M41pP09K"; // change the default LIFF value if you are not using a node server

            // DO NOT CHANGE THIS
            let myLiffId = "";

            // if node is used, fetch the environment variable and pass it to the LIFF method
            // otherwise, pass defaultLiffId
            if (useNodeJS) {
                fetch('/send-id')
                    .then(function (reqResponse) {
                        return reqResponse.json();
                    })
                    .then(function (jsonResponse) {
                        myLiffId = jsonResponse.id;
                        initializeLiffOrDie(myLiffId);
                    })
                    .catch(function (error) {
                        document.getElementById("liffAppContent").classList.add('hidden');
                        document.getElementById("nodeLiffIdErrorMessage").classList.remove('hidden');
                    });
            } else {
                myLiffId = defaultLiffId;
                initializeLiffOrDie(myLiffId);
            }
        };

        /**
         * Check if myLiffId is null. If null do not initiate liff.
         * @param {string} myLiffId The LIFF ID of the selected element
         */
        function initializeLiffOrDie(myLiffId) {
            if (!myLiffId) {
                document.getElementById("liffAppContent").classList.add('hidden');
                document.getElementById("liffIdErrorMessage").classList.remove('hidden');
            } else {
                initializeLiff(myLiffId);
            }
        }

        /**
         * Initialize LIFF
         * @param {string} myLiffId The LIFF ID of the selected element
         */



        function initializeLiff(myLiffId) {
            liff
                .init({
                    liffId: myLiffId
                })
                .then(() => {
                    // start to use LIFF's api
                    initializeApp();
                })
                .catch((err) => {
                    document.getElementById("liffAppContent").classList.add('hidden');
                    document.getElementById("liffInitErrorMessage").classList.remove('hidden');
                });
        }

        /**
         * Initialize the app by calling functions handling individual app components
         */
        function initializeApp() {
            registerButtonHandlers();
            registerButtonHandlerss();

            // check if the user is logged in/out, and disable inappropriate button
        }

        /**
         * Display data generated by invoking LIFF methods
        /**
         * Toggle the login/logout buttons based on the isInClient status, and display a message accordingly
         */

        /**
         * Register event handlers for the buttons displayed in the app
         */

        var draw1;
        $(function () {
            $.getJSON("edm00900.json", function (data) {
                draw1 = data;
            });
        });
        var draw2;
        $(function () {
            $.getJSON("6535.json", function (data) {
                draw2 = data;
            });
        });
        





        function registerButtonHandlerss() {
            $('#Buttontofriend').click(function () {
                var checkValue = $("#selectone").val();
                console.log(checkValue);
                if (checkValue == "6535") {
                    liff.shareTargetPicker([{
                                type: 'flex',
                                altText: '你有一則抽籤通知',
                                contents: draw2
                            //text: 'good'
                            //text: ('{"uid":"'+($('#msg-uid').val())+'",'+ '"number":"'+($('#msg-num').val())+'",'+'"phone":"'+($('#msg-pho').val())+'",'+'"temp":"'+($('#msg-temp').val())+'",'+'"special":"'+($('#msg-special').val())+'"}')
                        }])
                        .then(() => {
                            alert('訊息已傳送!');
                            liff.closeWindow();
                        })
                } else if (checkValue == "edm00900") {
                    liff.shareTargetPicker([{
                                type: 'flex',
                                altText: '你有一則EDM通知',
                                contents: draw1
                        }

                            
                            //text: 'good'
                            //text: ('{"uid":"'+($('#msg-uid').val())+'",'+ '"number":"'+($('#msg-num').val())+'",'+'"phone":"'+($('#msg-pho').val())+'",'+'"temp":"'+($('#msg-temp').val())+'",'+'"special":"'+($('#msg-special').val())+'"}')
                    ])
                        .then(() => {
                            alert('訊息已傳送!');
                            liff.closeWindow();
                        })

                }
            });
        }

        function registerButtonHandlers() {
            $('#ButtonSendMsg').click(function () {
                var ccc = $("#selectone").val();
                console.log(ccc);
                if (ccc == "6535") {
                    liff.sendMessages([{
                                type: 'flex',
                                altText: '你有一則抽籤通知',
                                contents: draw2
                            }
                            //text: 'good'
                            //text: ('{"uid":"'+($('#msg-uid').val())+'",'+ '"number":"'+($('#msg-num').val())+'",'+'"phone":"'+($('#msg-pho').val())+'",'+'"temp":"'+($('#msg-temp').val())+'",'+'"special":"'+($('#msg-special').val())+'"}')
                        ])
                        .then(() => {
                            alert('訊息已傳送');
                            liff.closeWindow();
                        })
                        .catch((err) => {
                            console.log('error', err);
                        });
                }
                if (ccc == "edm00900") {
                    liff.sendMessages([{
                                type: 'flex',
                                altText: '你有一則EDM通知',
                                contents: draw1

                            }
                            //text: 'good'
                            //text: ('{"uid":"'+($('#msg-uid').val())+'",'+ '"number":"'+($('#msg-num').val())+'",'+'"phone":"'+($('#msg-pho').val())+'",'+'"temp":"'+($('#msg-temp').val())+'",'+'"special":"'+($('#msg-special').val())+'"}')
                        ])
                        .then(() => {
                            alert('訊息已傳送!');
                            liff.closeWindow();
                        })
                        .catch((err) => {
                            console.log('error', err);
                        });

                }
                            
                            //text: 'good'
                            //text: ('{"uid":"'+($('#msg-uid').val())+'",'+ '"number":"'+($('#msg-num').val())+'",'+'"phone":"'+($('#msg-pho').val())+'",'+'"temp":"'+($('#msg-temp').val())+'",'+'"special":"'+($('#msg-special').val())+'"}')
                
            });
        }




        /**
         * Alert the user if LIFF is opened in an external browser and unavailable buttons are tapped
         */

        /**
         * Toggle scanCode result field
         */
        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
            var r = window.location.search.substr(1).match(reg); //匹配目标参数
            if (r != null) return unescape(r[2]);
            return null; //返回参数值
        }
        var val = getUrlParam('json1');
        $(document).ready(function () {
            console.log(val);
            if (val != null) {
                $('#selectone').prepend("<option value='6535'>抽籤通知-順藥</option>");
                $('#selectone').append("<option value='edm00900'>EDM-00900</option>");
                $('#selectone').val(val);
                $('#selectone').attr('disabled', 'disabled');
                $('#ButtonSendMsg').remove();

            } else {
                $('#selectone').prepend("<option value='6535' selected>抽籤通知-順藥</option>");
                $('#selectone').append("<option value='edm00900'>EDM-00900</option>");
            }




        });





        //var url1 = "./" + val + ".txt";
        //$(document).ready(function() {
        // $("#testvalue").val(val); 
        //   $.get(url1, function(data) {
        //     var fileDom = $(data);
        //   $("#testvalue").val(fileDom);
        //}, 'text');
        //
    </script>



    <div id="liffAppContent">
        <div style="background-color:#35CEBF" class="container">
            <!-- ACTION BUTTONS -->
            <br>
            <div class="container">
                <br>
                <select class="custom-select mr-sm-2" id="selectone">
                </select><br><br>

                <!-- <button class="btn btn-primary" id="scanQrCodeButton">掃同學的QRcode(限Android手機)</button> -->
                <button class="btn btn-primary text-center" name="thischat" id="ButtonSendMsg">傳送到這個聊天室</button><br />
                <br>

                <button class="btn btn-primary text-center" name="tofriend" id="Buttontofriend">分享給朋友</button><br />
                <br>
            </div>
            <br>
        </div>
        <!-- LIFF INIT ERROR -->
        <div id="liffInitErrorMessage" class="hidden">
            <p>Something went wrong with LIFF initialization.</p>
            <p>LIFF initialization can fail if a user clicks "Cancel" on the "Grant permission" screen, or if an error
                occurs in the process of <code>liff.init()</code>.
        </div>
        <!-- NODE.JS LIFF ID ERROR -->
        <div id="nodeLiffIdErrorMessage" class="hidden">
            <p>Unable to receive the LIFF ID as an environment variable.</p>
        </div>
</body>

</html>
